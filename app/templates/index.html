{% extends "base.html" %}
{% block title %}{{ _('Головна сторінка') }}{% endblock %}

{% block content %}
<div class="main-center-container">

  {% if info_block or gallery_block or projects_block or additional_blocks %}
  <div class="main-cards-row">
    <!-- Отображение стандартных блоков -->
    {% if info_block %}
    <div class="main-card info-block" onclick="openModal('info')">
      {% if info_block.image_data or info_block.image_url %}
      <img src="{{ url_for('block_images.block_image_file', block_id=info_block.id) }}" alt="" class="block-cover" loading="lazy" decoding="async" fetchpriority="low">
      {% endif %}
      <h3>{{ info_block.translated_title or info_block.title }}</h3>
      <div class="block-short">{{ (info_block.translated_content or info_block.content)[:80] }}...</div>
    </div>
    {% endif %}

    {% if gallery_block %}
    <div class="main-card gallery-block" onclick="openModal('gallery')">
      {% if gallery_block.image_data or gallery_block.image_url %}
      <img src="{{ url_for('block_images.block_image_file', block_id=gallery_block.id) }}" alt="" class="block-cover" loading="lazy" decoding="async" fetchpriority="low">
      {% endif %}
      <h3>{{ gallery_block.translated_title or gallery_block.title }}</h3>
      <div class="block-short">{{ (gallery_block.translated_content or gallery_block.content)[:80] }}...</div>
    </div>
    {% endif %}

    {% if projects_block %}
    <div class="main-card projects-block" onclick="openModal('projects')">
      {% if projects_block.image_data or projects_block.image_url %}
      <img src="{{ url_for('block_images.block_image_file', block_id=projects_block.id) }}" alt="" class="block-cover" loading="lazy" decoding="async" fetchpriority="low">
      {% endif %}
      <h3>{{ projects_block.translated_title or projects_block.title }}</h3>
      <div class="block-short">{{ (projects_block.translated_content or projects_block.content)[:80] }}...</div>
    </div>
    {% endif %}
    
    <!-- Отображение дополнительных блоков -->
    {% for block in additional_blocks %}
    {% if block.is_active %}
    <div class="main-card {{ block.type }}-block" onclick="openModal('additional-{{ block.id }}')">
      {% if block.image_data or block.image_url %}
      <img src="{{ url_for('block_images.block_image_file', block_id=block.id) }}" alt="" class="block-cover" loading="lazy" decoding="async" fetchpriority="low">
      {% endif %}
      <h3>{{ block.translated_title or block.title }}</h3>
      <div class="block-short">{{ (block.translated_content or block.content)[:80] }}...</div>
    </div>
    {% endif %}
    {% endfor %}
  </div>
  {% endif %}

</div>

<!-- Модальне вікно -->
{% if info_block or gallery_block or projects_block or additional_blocks %}
<div id="block-modal" class="block-modal" style="display: none;">
  <div class="block-modal-content">
    <span class="block-modal-close" onclick="closeModal()">&times;</span>

    {% if info_block %}
    <div id="modal-details-info" class="modal-details" style="display: none;">
      <h2>{{ info_block.translated_title or info_block.title }}</h2>
      {% if info_block.image_data or info_block.image_url %}
      <div class="modal-image-container">
        <img src="{{ url_for('block_images.block_image_file', block_id=info_block.id) }}" alt="" class="modal-image" loading="lazy" decoding="async">
      </div>
      {% endif %}
      <div>{{ (info_block.translated_content or info_block.content)|safe }}</div>
    </div>
    {% endif %}

    {% if gallery_block %}
    <div id="modal-details-gallery" class="modal-details" style="display: none;">
      <h2>{{ gallery_block.translated_title or gallery_block.title }}</h2>
      
      {% if gallery_block.image_data or gallery_block.image_url %}
      <div class="modal-image-container">
        <img src="{{ url_for('block_images.block_image_file', block_id=gallery_block.id) }}" alt="" class="modal-image" loading="lazy" decoding="async" fetchpriority="low">
      </div>
      {% endif %}
      
      <div>{{ (gallery_block.translated_content or gallery_block.content)|safe }}</div>

      <div id="gallery-carousel" class="gallery-carousel">
        <button id="gallery-prev" class="gallery-nav">&#8592;</button>
        <div id="gallery-slide" class="gallery-slide">
          {% for img in gallery_images %}
          <div class="gallery-item" data-index="{{ loop.index0 }}">
            {% if img.image_data %}
            <img src="{{ url_for('main.gallery_image_file', image_id=img.id) }}" 
                 alt="{{ img.description or 'Галерея' }}" 
                 class="gallery-img"
                 loading="lazy" decoding="async" fetchpriority="low">
            {% elif img.image_url %}
            <img src="{{ img.image_url }}" 
                 alt="{{ img.description or 'Галерея' }}" 
                 class="gallery-img"
                 loading="lazy" decoding="async" fetchpriority="low">
            {% else %}
            <img src="{{ url_for('static', filename='placeholder.png') }}" 
                 alt="Placeholder" 
                 class="gallery-img"
                 loading="lazy" decoding="async" fetchpriority="low">
            {% endif %}
            <div class="gallery-desc">{{ img.description }}</div>
          </div>
          {% endfor %}
        </div>
        <button id="gallery-next" class="gallery-nav">&#8594;</button>
        
        <!-- Индикаторы слайдов -->
        <div class="gallery-indicators" id="gallery-indicators"></div>
      </div>
    </div>
    {% endif %}

    {% if projects_block %}
    <div id="modal-details-projects" class="modal-details" style="display: none;">
      <h2>{{ projects_block.translated_title or projects_block.title }}</h2>
      {% if projects_block.image_data or projects_block.image_url %}
      <div class="modal-image-container">
        <img src="{{ url_for('block_images.block_image_file', block_id=projects_block.id) }}" alt="" class="modal-image" loading="lazy" decoding="async" fetchpriority="low">
      </div>
      {% endif %}
      <div>{{ (projects_block.translated_content or projects_block.content)|safe }}</div>

      <!-- Проекти як картки в модальному вікні -->
      {% if projects %}
      <div class="projects-list-row">
        {% for project in projects %}
        <div class="project-card">
          <h4>{{ project.title }}</h4>
          {% if project.image_data or project.image_url %}
          <img src="{{ url_for('main.project_image_file', project_id=project.id) }}" alt="фото проєкту" class="project-img" style="max-width:180px; margin-bottom:10px;" loading="lazy" decoding="async" fetchpriority="low">
          {% endif %}
          <div><strong>Мета:</strong> {{ project.goal[:60] }}...</div>
          <div><strong>Виконавець:</strong> {{ project.executor_info }}</div>
          <div><strong>Бюджет:</strong> &euro;{{ project.total_budget }}</div>
          <button onclick="openProjectModal('{{ project.id }}')" class="project-details-btn">Детальніше</button>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div>Немає схвалених проєктів для відображення.</div>
      {% endif %}
    </div>
    {% endif %}
    
    <!-- Модальные окна для дополнительных блоков -->
    {% for block in additional_blocks %}
    {% if block.is_active %}
    <div id="modal-details-additional-{{ block.id }}" class="modal-details" style="display: none;">
      <h2>{{ block.translated_title or block.title }}</h2>
      {% if block.image_data or block.image_url %}
      <div class="modal-image-container">
        <img src="{{ url_for('block_images.block_image_file', block_id=block.id) }}" alt="" class="modal-image" loading="lazy" decoding="async" fetchpriority="low">
      </div>
      {% endif %}
      <div>{{ (block.translated_content or block.content)|safe }}</div>
    </div>
    {% endif %}
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- Модальні вікна для кожного проєкту -->
{% if projects %}
<div class="projects-list-row">
  {% for project in projects %}
  <div id="project-modal-{{ project.id }}" class="project-details-modal" style="display:none;">
    <div class="project-details-modal-content">
      <span class="project-details-modal-close" onclick="closeProjectModal('{{ project.id }}')">&times;</span>
      <h2>{{ project.title }}</h2>
      {% if project.image_data or project.image_url %}
      <img src="{{ url_for('main.project_image_file', project_id=project.id) }}" alt="фото проєкту"
        class="project-img" style="max-width:300px; margin-bottom:18px;" loading="lazy" decoding="async" fetchpriority="low">
      {% endif %}
      <p><strong>Мета:</strong> {{ project.goal }}</p>
      <p><strong>Проблема:</strong> {{ project.problem_description }}</p>
      <p><strong>Очікуваний результат:</strong> {{ project.expected_result }}</p>
      <p><strong>Бюджет:</strong> &euro;{{ project.total_budget }}</p>
      <p><strong>Виконавець:</strong> {{ project.executor_info }}</p>
      <p><strong>Тривалість:</strong> {{ project.duration }}</p>
      <p><strong>Категорія:</strong> {{ project.category }}</p>
      <p><strong>Місце реалізації:</strong> {{ project.location }}</p>
      <p><strong>Соцмережі:</strong> {{ project.social_links }}</p>
      <p><strong>Статус:</strong> {{ project.status }}</p>
      <p><strong>Кількість голосів:</strong> {{ project.votes.count() }}</p>
      <form method="post" action="/vote/{{ project.id }}" style="margin-top:18px;">
        <button type="submit">Голосувати</button>
      </form>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- JS -->
<script>
function openModal(type) {
  const modal = document.getElementById('block-modal');
  if (modal) {
    // Сначала применяем эффект появления
    modal.style.opacity = '0';
    modal.style.display = 'flex';
    
    // Сначала скрываем все детали
    const allModalDetails = document.querySelectorAll('.modal-details');
    allModalDetails.forEach(detail => {
      detail.style.display = 'none';
    });
    
    // Затем показываем нужные
    const modalDetails = document.getElementById('modal-details-' + type);
    if (modalDetails) {
      modalDetails.style.display = 'block';
      
      // Добавляем плавное появление
      setTimeout(() => {
        modal.style.opacity = '1';
        modal.style.transition = 'opacity 0.4s ease';
        
        // Обрабатываем изображения для правильного отображения
        const modalImages = modalDetails.querySelectorAll('.modal-image');
        if (modalImages.length > 0) {
          modalImages.forEach(img => {
            // Проверяем, загружено ли изображение
            if (img.complete) {
              enhanceImage(img);
            } else {
              img.onload = () => enhanceImage(img);
            }
          });
        }
        
        // Инициализируем карусель, если это галерея
        if (type === 'gallery') {
          initGalleryCarousel();
        }
      }, 50);
      
      document.body.style.overflow = 'hidden';
    } else {
      console.error('Modal details for type "' + type + '" not found');
    }
  } else {
    console.error('Modal element not found');
  }
}

// Функция для улучшения отображения изображений
function enhanceImage(img) {
  // Проверяем размеры изображения и адаптируем контейнер
  const container = img.parentElement;
  if (container && container.classList.contains('modal-image-container')) {
    // Если изображение большое, добавляем возможность клика для увеличения
    img.style.cursor = 'pointer';
    img.addEventListener('click', function() {
      if (this.classList.contains('expanded')) {
        this.classList.remove('expanded');
        this.style.maxHeight = '';
        this.style.objectFit = '';
        container.style.maxHeight = '';
      } else {
        this.classList.add('expanded');
        this.style.maxHeight = '95vh';
        this.style.objectFit = 'contain';
        container.style.maxHeight = '95vh';
      }
    });
  }
}

function closeModal() {
  const modal = document.getElementById('block-modal');
  if (modal) {
    // Плавное скрытие модального окна
    modal.style.opacity = '0';
    modal.style.transition = 'opacity 0.3s ease';
    
    // После завершения анимации скрываем окно
    setTimeout(() => {
      modal.style.display = 'none';
      const modalDetails = modal.querySelectorAll('.modal-details');
      modalDetails.forEach(detail => detail.style.display = 'none');
      
      // Сбрасываем стили у изображений
      const modalImages = modal.querySelectorAll('.modal-image');
      modalImages.forEach(img => {
        img.classList.remove('expanded');
        img.style.maxHeight = '';
        img.style.objectFit = '';
        if (img.parentElement) {
          img.parentElement.style.maxHeight = '';
        }
      });
    }, 300);
    
    document.body.style.overflow = '';
  } else {
    console.error('Modal element not found');
  }
}

function initGalleryCarousel() {
  const items = document.querySelectorAll('.gallery-item');
  let currentIndex = 0;

  // Создаем индикаторы слайдов
  const indicatorsContainer = document.getElementById('gallery-indicators');
  if (indicatorsContainer) {
    items.forEach((_, i) => {
      const indicator = document.createElement('div');
      indicator.className = 'gallery-indicator';
      indicator.addEventListener('click', () => {
        currentIndex = i;
        showItem(currentIndex);
      });
      indicatorsContainer.appendChild(indicator);
    });
  }

  function showItem(index) {
    items.forEach((item, i) => {
      item.classList.toggle('active', i === index);
    });
    
    // Обновляем индикаторы
    if (indicatorsContainer) {
      const indicators = indicatorsContainer.querySelectorAll('.gallery-indicator');
      indicators.forEach((indicator, i) => {
        indicator.classList.toggle('active', i === index);
      });
    }
  }

  document.getElementById('gallery-prev').onclick = () => {
    currentIndex = (currentIndex - 1 + items.length) % items.length;
    showItem(currentIndex);
  };

  document.getElementById('gallery-next').onclick = () => {
    currentIndex = (currentIndex + 1) % items.length;
    showItem(currentIndex);
  };

  showItem(currentIndex);
}

function openProjectModal(id) {
  const modal = document.getElementById('project-modal-' + id);
  if (modal) modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeProjectModal(id) {
  const modal = document.getElementById('project-modal-' + id);
  if (modal) modal.style.display = 'none';
  document.body.style.overflow = '';
}
</script>
{% endblock %}
