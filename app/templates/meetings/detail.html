{% extends "base.html" %}

{% block title %}{{ meeting.title }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('meeting.meetings_list') }}">{{ _('Meetings') }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ meeting.title }}</li>
        </ol>
    </nav>

    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="mb-0">{{ meeting.title }}</h2>
            <span class="badge {% if meeting.status.value == 'planned' %}bg-warning{% elif meeting.status.value == 'active' %}bg-success{% elif meeting.status.value == 'completed' %}bg-primary{% else %}bg-danger{% endif %}">
                {{ _(meeting.status.value|capitalize) }}
            </span>
        </div>
        <div class="card-body">
            <p class="card-text">{{ meeting.description }}</p>
            <div class="row mb-3">
                <div class="col-md-6">
                    <p><strong>{{ _('Date') }}:</strong> {{ meeting.date.strftime('%d.%m.%Y %H:%M') }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>{{ _('Created by') }}:</strong> {{ meeting.creator.full_name }}</p>
                </div>
            </div>

            {% if meeting.protocol_url %}
            <div class="mb-3">
                <a href="{{ meeting.protocol_url }}" target="_blank" class="btn btn-outline-primary">
                    <i class="fa fa-file-pdf"></i> {{ _('View Protocol') }}
                </a>
            </div>
            {% endif %}

            <div class="meeting-actions mb-3">
                {% if current_user.is_founder %}
                    {% if meeting.status.value == 'planned' %}
                    <form method="post" action="{{ url_for('meeting.activate_meeting', meeting_id=meeting.id) }}" class="d-inline">
                        <button type="submit" class="btn btn-success">
                            <i class="fa fa-play-circle"></i> {{ _('Activate Meeting') }}
                        </button>
                    </form>
                    {% endif %}
                    
                    {% if meeting.status.value == 'active' %}
                    <form method="post" action="{{ url_for('meeting.complete_meeting', meeting_id=meeting.id) }}" class="d-inline">
                        <button type="submit" class="btn btn-primary">
                            <i class="fa fa-check-circle"></i> {{ _('Complete Meeting') }}
                        </button>
                    </form>
                    {% endif %}
                    
                    {% if meeting.status.value != 'completed' %}
                    <a href="{{ url_for('meeting.edit_meeting', meeting_id=meeting.id) }}" class="btn btn-secondary">
                        <i class="fa fa-edit"></i> {{ _('Edit Meeting') }}
                    </a>
                    {% endif %}
                    
                    {% if meeting.status.value != 'completed' %}
                    <a href="{{ url_for('meeting.manage_agenda', meeting_id=meeting.id) }}" class="btn btn-info">
                        <i class="fa fa-list"></i> {{ _('Manage Agenda') }}
                    </a>
                    {% endif %}
                    
                    {% if meeting.status.value == 'active' %}
                    <form method="post" action="{{ url_for('meeting.mark_attendance', meeting_id=meeting.id) }}" class="d-inline">
                        <button type="submit" class="btn btn-outline-success">
                            <i class="fa fa-user-check"></i> {{ _('Mark Attendance') }}
                        </button>
                    </form>
                    {% endif %}
                {% endif %}
                
                {% if meeting.status.value == 'completed' and current_user.is_founder and not meeting.protocol_url %}
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#protocolModal">
                    <i class="fa fa-upload"></i> {{ _('Upload Protocol') }}
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Attendees Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0">{{ _('Attendees') }} ({{ meeting.attendee_count }})</h3>
        </div>
        <div class="card-body">
            {% if meeting.attendees.all() %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>{{ _('Name') }}</th>
                            <th>{{ _('Joined At') }}</th>
                            <th>{{ _('Left At') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for attendee in meeting.attendees.all() %}
                        <tr>
                            <td>{{ attendee.user.full_name }}</td>
                            <td>{{ attendee.joined_at.strftime('%H:%M') }}</td>
                            <td>{{ attendee.left_at.strftime('%H:%M') if attendee.left_at else '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="card-text">{{ _('No attendees yet.') }}</p>
            {% endif %}
            
            <!-- Quorum status -->
            <div class="alert {% if meeting.has_quorum %}alert-success{% else %}alert-warning{% endif %} mt-3">
                {% if meeting.has_quorum %}
                <i class="fa fa-check-circle"></i> {{ _('Quorum reached') }}
                {% else %}
                <i class="fa fa-exclamation-triangle"></i> {{ _('Quorum not reached') }}
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Agenda Items -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0">{{ _('Agenda') }}</h3>
        </div>
        <div class="card-body">
            {% if agenda_items %}
            <div class="list-group">
                {% for item in agenda_items %}
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">{{ item.title }}</h5>
                        {% if item.requires_voting %}
                        <span class="badge bg-info">{{ _('Requires Voting') }}</span>
                        {% endif %}
                    </div>
                    <p class="mb-1">{{ item.description }}</p>
                    
                    {% if item.requires_voting %}
                    <div class="voting-section mt-3">
                        <h6>{{ _('Voting Results') }}</h6>
                        <div class="progress" style="height: 25px;">
                            {% set total_votes = item.yes_votes + item.no_votes + item.abstain_votes %}
                            {% set yes_percentage = (item.yes_votes / total_votes * 100) if total_votes > 0 else 0 %}
                            {% set no_percentage = (item.no_votes / total_votes * 100) if total_votes > 0 else 0 %}
                            {% set abstain_percentage = (item.abstain_votes / total_votes * 100) if total_votes > 0 else 0 %}
                            
                            <div class="progress-bar bg-success vote-bar" role="progressbar"
                                 data-width="{{ yes_percentage }}"
                                 aria-valuenow="{{ yes_percentage }}" aria-valuemin="0" aria-valuemax="100">
                                {{ item.yes_votes }} {{ _('Yes') }}
                            </div>
                            <div class="progress-bar bg-danger vote-bar" role="progressbar"
                                 data-width="{{ no_percentage }}"
                                 aria-valuenow="{{ no_percentage }}" aria-valuemin="0" aria-valuemax="100">
                                {{ item.no_votes }} {{ _('No') }}
                            </div>
                            <div class="progress-bar bg-secondary vote-bar" role="progressbar"
                                 data-width="{{ abstain_percentage }}"
                                 aria-valuenow="{{ abstain_percentage }}" aria-valuemin="0" aria-valuemax="100">
                                {{ item.abstain_votes }} {{ _('Abstain') }}
                            </div>
                        </div>
                        
                        <!-- Result Summary -->
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div>
                                <small class="text-muted">{{ _('Total Votes') }}: {{ total_votes }}</small>
                            </div>
                            <div>
                                <span class="badge {% if item.result == 'Approved' %}bg-success{% elif item.result == 'Rejected' %}bg-danger{% else %}bg-warning{% endif %}">
                                    {{ _(item.result) }}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Voting Form for Founders -->
                        {% if current_user.is_founder and meeting.status.value == 'active' %}
                        <div class="card mt-3">
                            <div class="card-header">{{ _('Cast Your Vote') }}</div>
                            <div class="card-body">
                                <form class="voting-form" data-item-id="{{ item.id }}">
                                    <div class="form-group mb-3">
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="vote" id="yes-{{ item.id }}" value="yes" 
                                                  {% if user_votes.get(item.id) == 'yes' %}checked{% endif %}/>
                                            <label class="btn btn-outline-success" for="yes-{{ item.id }}">{{ _('Yes') }}</label>
                                            
                                            <input type="radio" class="btn-check" name="vote" id="no-{{ item.id }}" value="no"
                                                  {% if user_votes.get(item.id) == 'no' %}checked{% endif %}/>
                                            <label class="btn btn-outline-danger" for="no-{{ item.id }}">{{ _('No') }}</label>
                                            
                                            <input type="radio" class="btn-check" name="vote" id="abstain-{{ item.id }}" value="abstain"
                                                  {% if user_votes.get(item.id) == 'abstain' %}checked{% endif %}/>
                                            <label class="btn btn-outline-secondary" for="abstain-{{ item.id }}">{{ _('Abstain') }}</label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group mb-3">
                                        <textarea class="form-control" name="comment" placeholder="{{ _('Optional comment') }}"></textarea>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary">{{ _('Submit Vote') }}</button>
                                    <div class="vote-status mt-2"></div>
                                </form>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="card-text">{{ _('No agenda items yet.') }}</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Protocol Upload Modal -->
{% if meeting.status.value == 'completed' and current_user.is_founder %}
<div class="modal fade" id="protocolModal" tabindex="-1" aria-labelledby="protocolModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="protocolModalLabel">{{ _('Upload Protocol') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{{ url_for('meeting.upload_protocol', meeting_id=meeting.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="protocol_url" class="form-label">{{ _('Protocol URL') }}</label>
                        <input type="url" class="form-control" id="protocol_url" name="protocol_url" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
                    <button type="submit" class="btn btn-primary">{{ _('Save') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle voting forms
    const votingForms = document.querySelectorAll('.voting-form');
    votingForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const itemId = this.dataset.itemId;
            const formData = new FormData(this);
            const statusDiv = this.querySelector('.vote-status');
            
            fetch(`/meetings/agenda/${itemId}/vote`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    statusDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                    
                    // Update voting results without page reload
                    const results = data.results;
                    const totalVotes = results.yes + results.no + results.abstain;
                    
                    // You would need to update the progress bars and counts here
                    // This would require adding specific IDs to the elements to update
                    
                    setTimeout(() => {
                        location.reload(); // For simplicity, reload the page
                    }, 1500);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statusDiv.innerHTML = `<div class="alert alert-danger">{{ _('An error occurred while processing your vote') }}</div>`;
            });
        });
    });
});

// Initialize vote progress bars
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.vote-bar').forEach(function(bar) {
        const width = bar.getAttribute('data-width');
        bar.style.width = width + '%';
    });
});
</script>
{% endblock %}
